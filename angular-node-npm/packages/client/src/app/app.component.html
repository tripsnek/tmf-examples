<div class="tmf-editor">
  <!-- Header -->
  <header class="editor-header">
    <div class="header-content">
      <div class="logo">TMF</div>
      <h1>Reflective Model Editor</h1>
      <div class="package-info" *ngIf="ePackage">
        <span class="package-name">EPackage: {{ ePackage.getName() }}</span>
        <span class="package-uri">{{ ePackage.getNsURI() }}</span>
      </div>
      <div class="connection-status" [class.connected]="connectionStatus.connected">
        <span class="status-indicator"></span>
        <span class="status-text">{{ connectionStatus.message }}</span>
        <button 
          *ngIf="connectionStatus.connected"
          class="btn btn-sm btn-secondary refresh-btn"
          (click)="checkServerAndLoadData()"
          title="Reload from server"
        >
          üîÑ
        </button>
      </div> 
    </div>
  </header>

  <div class="editor-body">
    <!-- Tree Panel -->
    <aside class="tree-panel">
      <div class="panel-header">
        <h2>Model Instances</h2>
        <div class="panel-actions">
          <button class="btn btn-primary" (click)="showCreateDialog()">
            <span class="icon">+</span> Create
          </button>
          <button
            class="btn btn-danger"
            [disabled]="!selectedInstance"
            (click)="deleteInstance()"
          >
            <span class="icon">üóë</span> Delete
          </button>
        </div>
      </div>

      <div class="tree-content">
        <div *ngIf="rootClassNodes.length === 0" class="empty-state">
          <div class="empty-icon">üì¶</div>
          <p>No model loaded</p>
          <small>Load a metamodel to get started</small>
        </div>

        <div class="tree" *ngIf="rootClassNodes.length > 0">
          <!-- Root Class Nodes -->
          <div *ngFor="let rootNode of rootClassNodes" class="root-class-node">
            <div class="root-class-header">
              <span
                class="tree-toggle"
                *ngIf="rootNode.instances.length > 0"
                (click)="toggleRootClassExpanded(rootNode, $event)"
              >
                {{ rootNode.expanded ? "‚ñº" : "‚ñ∂" }}
              </span>
              <!-- <span class="tree-icon" *ngIf="rootNode.instances.length === 0">‚Ä¢</span> -->
              <span class="root-class-label">{{ rootNode.eClass.getName() }}s</span>
              <button
                class="btn btn-sm btn-primary root-create-btn"
                (click)="createInstanceForRootClass(rootNode.eClass)"
              >
                + Create
              </button>
            </div>
            
            <div class="tree-children" *ngIf="rootNode.expanded">
              <ng-container *ngFor="let instance of rootNode.instances">
                <ng-container
                  *ngTemplateOutlet="
                    treeNode;
                    context: { $implicit: instance, level: 1 }
                  "
                ></ng-container>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Properties Panel -->
    <main class="properties-panel">
      <div class="panel-header">
        <h2>Properties</h2>
        <div class="instance-info" *ngIf="selectedInstance">
          <span class="instance-type">{{
            getEClassName(selectedInstance.eObject)
          }}</span>
        </div>
      </div>

      <div class="properties-content">
        <div *ngIf="!selectedInstance" class="empty-state">
          <div class="empty-icon">üîç</div>
          <p>Select an instance</p>
          <small>Choose an instance from the tree to view its properties</small>
        </div>

        <div
          *ngIf="selectedInstance"
          class="property-groups"
          style="max-width: 500px"
        >
          <!-- Attributes Group -->
          <div class="property-group" *ngIf="getAttributes().length > 0">
            <div class="group-header">
              <span class="group-icon">üìù</span>
              <h3>Attributes</h3>
            </div>
            <div class="group-content">
              <div class="property-field" *ngFor="let attr of getAttributes(); let i = index">
                <label class="property-label">
                  {{ attr.getName() }}
                  <span class="property-meta" *ngIf="attr.isId()">(ID)</span>
                  <span class="property-meta" *ngIf="attr.isMany()"
                    >[{{ attr.getLowerBound() }}..{{
                      attr.getUpperBound() === -1 ? "*" : attr.getUpperBound()
                    }}]</span
                  >
                  <span class="property-type">{{
                    getAttributeType(attr)
                  }}</span>
                </label>
                <div class="property-control">
                  <!-- Many-valued attributes -->
                  <div *ngIf="attr.isMany()" class="reference-list">
                    <div
                      class="reference-item"
                      *ngFor="
                        let value of getAttributeValues(attr);
                        let j = index
                      "
                    >
                      <span class="reference-label">{{ value }}</span>
                      <button
                        class="btn btn-sm btn-danger"
                        (click)="removeAttributeValue(attr, j)"
                      >
                        √ó
                      </button>
                    </div>
                    <!-- String type input -->
                    <div
                      *ngIf="isStringType(attr)"
                      style="display: flex; gap: 0.5rem; align-items: center"
                    >
                      <input
                        type="text"
                        class="form-input"
                        #stringValue
                        #propertyInput
                        placeholder="New value"
                        (keyup.enter)="addAttributeValue(attr, stringValue)"
                      />
                      <button
                        class="btn btn-sm btn-primary"
                        (click)="addAttributeValue(attr, stringValue)"
                      >
                        + Add
                      </button>
                    </div>
                    <!-- Number type input -->
                    <div
                      *ngIf="isNumberType(attr)"
                      style="display: flex; gap: 0.5rem; align-items: center"
                    >
                      <input
                        type="number"
                        class="form-input"
                        #numberValue
                        #propertyInput
                        placeholder="New value"
                        (keyup.enter)="addAttributeValue(attr, numberValue)"
                      />
                      <button
                        class="btn btn-sm btn-primary"
                        (click)="addAttributeValue(attr, numberValue)"
                      >
                        + Add
                      </button>
                    </div>
                    <!-- Enum type input -->
                    <div
                      *ngIf="isEnumType(attr)"
                      style="display: flex; gap: 0.5rem; align-items: center"
                    >
                      <select class="form-select" #enumValue #propertyInput>
                        <option
                          *ngFor="let literal of getEnumLiterals(attr)"
                          [value]="literal"
                        >
                          {{ literal }}
                        </option>
                      </select>
                      <button
                        class="btn btn-sm btn-primary"
                        (click)="addAttributeValue(attr, enumValue)"
                      >
                        + Add
                      </button>
                    </div>
                  </div>

                  <!-- Single-valued attributes -->
                  <ng-container *ngIf="!attr.isMany()">
                    <input
                      *ngIf="isStringType(attr)"
                      type="text"
                      class="form-input"
                      #propertyInput
                      [value]="getAttributeValue(attr)"
                      (change)="setAttributeValue(attr, $event)"
                    />
                    <input
                      *ngIf="isNumberType(attr)"
                      type="number"
                      class="form-input"
                      #propertyInput
                      [value]="getAttributeValue(attr)"
                      (change)="setAttributeValue(attr, $event)"
                    />
                    <input
                      *ngIf="isBooleanType(attr)"
                      type="checkbox"
                      class="form-checkbox"
                      #propertyInput
                      [checked]="getAttributeValue(attr)"
                      (change)="setAttributeValue(attr, $event)"
                    />
                    <input
                      *ngIf="isDateType(attr)"
                      type="date"
                      class="form-input"
                      #propertyInput
                      [value]="getAttributeValue(attr)"
                      (change)="setAttributeValue(attr, $event)"
                    />
                    <select
                      *ngIf="isEnumType(attr)"
                      class="form-select"
                      #propertyInput
                      [value]="getAttributeValue(attr)"
                      (change)="setAttributeValue(attr, $event)"
                    >
                      <option
                        *ngFor="let literal of getEnumLiterals(attr)"
                        [value]="literal"
                      >
                        {{ literal }}
                      </option>
                    </select>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>

          <!-- References Group -->
          <div class="property-group" *ngIf="getReferences().length > 0">
            <div class="group-header">
              <span class="group-icon">üîó</span>
              <h3>References</h3>
            </div>
            <div class="group-content">
              <div class="property-field" *ngFor="let ref of getReferences()">
                <div *ngIf="!ref.isContainer()">
                  <label class="property-label">
                    {{ ref.getName() }}
                    <span class="property-meta" *ngIf="ref.isContainment()"
                      >(containment)</span
                    >
                    <span class="property-meta" *ngIf="ref.isMany()"
                      >[{{ ref.getLowerBound() }}..{{
                        ref.getUpperBound() === -1 ? "*" : ref.getUpperBound()
                      }}]</span
                    >
                    <span class="property-type">{{
                      ref.getEType().getName()
                    }}</span>
                  </label>

                  <div class="reference-control">
                    <div *ngIf="ref.isMany()" class="reference-list">
                      <div
                        class="reference-item"
                        *ngFor="let target of getReferenceValues(ref)"
                        (click)="selectReferenceTarget(target)"
                      >
                        <span class="reference-label" style="cursor: pointer">{{
                          getInstanceLabel(target)
                        }}</span>
                        <button
                          class="btn btn-sm btn-danger"
                          (click)="removeReference(ref, target, $event)"
                        >
                          √ó
                        </button>
                      </div>
                      <button
                        class="btn btn-sm btn-primary"
                        *ngIf="ref.isContainment()"
                        (click)="showCreateContainmentDialog(ref)"
                      >
                        + Create {{ ref.getName() }}
                      </button>
                      <button
                        class="btn btn-sm btn-primary"
                        *ngIf="!ref.isContainment()"
                        (click)="showAddReferenceDialog(ref)"
                      >
                        + Add {{ ref.getName() }}
                      </button>
                    </div>

                    <div *ngIf="!ref.isMany()" class="reference-single">
                      <div
                        class="reference-item"
                        *ngIf="getReferenceValue(ref)"
                        (click)="selectReferenceTarget(getReferenceValue(ref))"
                      >
                        <span class="reference-label" style="cursor: pointer">{{
                          getInstanceLabel(getReferenceValue(ref))
                        }}</span>
                        <button
                          class="btn btn-sm btn-danger"
                          (click)="clearReference(ref, $event)"
                        >
                          √ó
                        </button>
                      </div>
                      <button
                        *ngIf="!getReferenceValue(ref) && ref.isContainment()"
                        class="btn btn-sm btn-primary"
                        (click)="showCreateContainmentDialog(ref)"
                      >
                        Create {{ ref.getName() }}
                      </button>
                      <button
                        *ngIf="!getReferenceValue(ref) && !ref.isContainment()"
                        class="btn btn-sm btn-primary"
                        (click)="showSetReferenceDialog(ref)"
                      >
                        Set {{ ref.getName() }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create Instance Dialog -->
  <div class="dialog" *ngIf="showCreateInstanceDialog">
    <div class="dialog-backdrop" (click)="hideCreateDialog()"></div>
    <div class="dialog-content">
      <div class="dialog-header">
        <h3>
          {{
            isContainmentCreation
              ? "Create " + containmentReference?.getName()
              : "Create New Instance"
          }}
        </h3>
        <button class="dialog-close" (click)="hideCreateDialog()">√ó</button>
      </div>

      <div class="dialog-body">
        <div class="form-group">
          <label>Select Class Type</label>
          <div class="class-grid">
            <div
              class="class-card"
              *ngFor="let eClass of getAvailableClasses()"
              [class.selected]="selectedEClass === eClass"
              (click)="selectEClass(eClass)"
            >
              <div class="class-name">{{ eClass.getName() }}</div>
              <div class="class-info">
                <span>{{ eClass.getEAttributes().size() }} attributes</span>
                <span>{{ eClass.getEReferences().size() }} references</span>
              </div>
              <div class="class-badges">
                <span class="badge badge-abstract" *ngIf="eClass.isAbstract()"
                  >abstract</span
                >
                <span class="badge badge-interface" *ngIf="eClass.isInterface()"
                  >interface</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="dialog-footer">
        <button class="btn btn-secondary" (click)="hideCreateDialog()">
          Cancel
        </button>
        <button
          class="btn btn-primary"
          [disabled]="!selectedEClass"
          (click)="createInstance()"
        >
          Create
        </button>
      </div>
    </div>
  </div>

  <!-- Reference Dialog -->
  <div class="dialog" *ngIf="showReferenceDialog">
    <div class="dialog-backdrop" (click)="hideReferenceDialog()"></div>
    <div class="dialog-content">
      <div class="dialog-header">
        <h3>{{ referenceDialogTitle }}</h3>
        <button class="dialog-close" (click)="hideReferenceDialog()">√ó</button>
      </div>

      <div class="dialog-body">
        <div class="form-group">
          <label>Select Target Instance</label>
          <select
            class="form-select"
            [(ngModel)]="selectedReferenceTargetIndex"
            [compareWith]="compareInstances"
          >
            <option [value]="-1">Select an instance...</option>
            <option
              *ngFor="let instance of getValidReferenceTargets(); let i = index"
              [value]="i"
            >
              {{ getInstanceLabel(instance.eObject) }}
            </option>
          </select>
        </div>
      </div>

      <div class="dialog-footer">
        <button class="btn btn-secondary" (click)="hideReferenceDialog()">
          Cancel
        </button>
        <button
          class="btn btn-primary"
          [disabled]="selectedReferenceTargetIndex === -1"
          (click)="applyReference()"
        >
          {{ currentReference?.isMany() ? "Add" : "Set" }} Reference
        </button>
      </div>
    </div>
  </div>

  <!-- Tree Node Template -->
  <ng-template #treeNode let-instance let-level="level">
    <div class="tree-node" [style.margin-left.px]="level * 20">
      <div
        class="tree-node-content"
        [class.selected]="selectedInstance === instance"
        (click)="selectInstance(instance)"
      >
        <span
          class="tree-toggle"
          *ngIf="instance.children.length > 0"
          (click)="toggleExpanded(instance, $event)"
        >
          {{ instance.expanded ? "‚ñº" : "‚ñ∂" }}
        </span>
        <!-- <span class="tree-icon" *ngIf="instance.children.length === 0">‚Ä¢</span> -->
        <span class="tree-label">{{ getInstanceLabel(instance.eObject) }}</span>
        <span class="tree-type">{{ getEClassName(instance.eObject) }}</span>
      </div>

      <div class="tree-children" *ngIf="instance.expanded">
        <ng-container *ngFor="let child of instance.children">
          <ng-container
            *ngTemplateOutlet="
              treeNode;
              context: { $implicit: child, level: level + 1 }
            "
          ></ng-container>
        </ng-container>
      </div>
    </div>
  </ng-template>
</div>